#!/bin/sh
# /etc/runit/runsvdir/default/wg0/run

# --- Environment ---
# Set a full PATH so wg-quick can find ip, wg, iptables, etc.
echo "RUN: attempting wireguard start" > /dev/kmsg
echo "RUN: attempting wireguard start"
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export PATH

# Redirect stderr to stdout so runit logs both
exec 2>&1

# --- Logging (optional) ---
# If you want logs, ensure /var/log/wg0 exists
# mkdir -p /var/log/wg0
# exec svlogd -tt /var/log/wg0 &

# --- Start WireGuard ---
# Use full path to config to avoid "file not found"
WG_CONF="/etc/wireguard/wg0.conf"

# Bring up the interface
sleep 5
if [ -f "$WG_CONF" ]; then
    echo "RUN: Starting wg0..." > /dev/kmsg
    echo "RUN: Starting wg0..."
    wg-quick up "$WG_CONF"
else
    echo "RUN: wireguard config not found" > /dev/kmsg
    echo "RUN: wireguard config not found"
    exit 1
fi

# one shot service, check dmesg
# note: nvm
echo "RUN: wireguard brought up successfully" > /dev/kmsg
echo "RUN: wireguard brought up successfully"
exec tail -f /dev/null
